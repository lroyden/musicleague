---
title: "32F Music League"
author: "Laura Royden"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load packages, include=FALSE}
library(tidyverse)
library(knitr)
library(DT)
```

```{r get data, include=FALSE}
library(tidyverse)

setwd("~/MIT Dropbox/Laura Royden/musicleague")

dirs <- list.dirs(path = ".", recursive = FALSE, full.names = FALSE)
dirs <- dirs[str_starts(dirs, "export_")]

base_dir <- getwd()

all_data <- data.frame()
for (folder in dirs) {
  setwd(file.path(base_dir, folder))
  
  votes <- read_csv("votes.csv")
  competitors <- read_csv("competitors.csv")
  rounds <- read_csv("rounds.csv")
  submissions <- read_csv("submissions.csv")
  
  
  ## clean up duplicate column names
  
  votes <- votes %>%
    rename(Voter_Comment = Comment,
           Vote_Time = Created,
           Voter_ID = `Voter ID`,
           Round_ID = `Round ID`)
  
  rounds <- rounds %>%
    rename(Round_Time = Created,
           Round_Name = Name,
           Round_Description = Description,
           Round_ID = ID)
  
  submissions <- submissions %>%
    rename(Submissions_Time = Created,
           Submitter_ID = `Submitter ID`,
           Submitter_Comment = Comment,
           Round_ID = `Round ID`)
  
  competitors <- competitors %>%
    rename(Person_ID = ID)
  
  # join votes and submission
  join <- left_join(votes, submissions, by=c("Spotify URI", "Round_ID"))
  
  # join rounds onto it
  join <- left_join(join, rounds, by="Round_ID")
  
  
  # join competitors onto it
  join <- join %>%
    left_join(competitors, by = c("Voter_ID" = "Person_ID")) %>%
    rename(Voter_Name = Name) %>%
    left_join(competitors, by = c("Submitter_ID" = "Person_ID")) %>%
    rename(Submitter_Name = Name) %>%
    select(-Voter_ID, -Submitter_ID) %>%
    mutate(Source_Export = folder)

  
  all_data <- rbind(all_data, join)
  
  rm(competitors, join, rounds, submissions, votes)
}

setwd("~/MIT Dropbox/Laura Royden/musicleague")

all_data <- all_data %>% select(Round_Name, Round_Description,	Title,	Album,	`Artist(s)`, Submitter_Name,	Submitter_Comment,	Voter_Name,	`Points Assigned`,	Voter_Comment,	`Playlist URL`,	Vote_Time,	Round_ID,	Submissions_Time,	`Visible To Voters`, Round_Time,	Source_Export)




just_submissions <- all_data %>% select(
  Round_Name, Round_Description, Title, `Artist(s)`, Album, Submitter_Name, Submitter_Comment
) %>% unique()



shorten_with_tooltip <- function(x, n = 80) {
  x <- replace_na(x, "")
  needs <- nchar(x) > n
  shown <- ifelse(needs, paste0(substr(x, 1, n), "â€¦"), x)
  # escape HTML in text to be safe
  esc <- htmltools::htmlEscape
  sprintf('<span title="%s">%s</span>', esc(x), esc(shown))
}

linkify <- function(url) {
  url <- replace_na(url, "")
  ifelse(nchar(url) == 0, "",
         sprintf('<a href="%s" target="_blank" rel="noopener">link</a>',
                 htmltools::htmlEscape(url)))
}

dt_opts <- list(
  pageLength = 25,
  lengthMenu = c(25, 50, 100, 250),
  dom = "Bfrtip",                           # Buttons + filter + table
  buttons = c("copy", "csv", "excel"),
  deferRender = TRUE,                       # speeds up initial draw
  scrollX = TRUE
)


```

## Just submissions

```{r just-submissions, echo=FALSE, message=FALSE, warning=FALSE}
display_sub <- just_submissions %>% 
  mutate(
    Round_Description = shorten_with_tooltip(Round_Description, 120),
    Submitter_Comment = shorten_with_tooltip(Submitter_Comment, 120)
  ) %>% select(Title, `Artist(s)`, Album, Submitter_Name, Submitter_Comment, Round_Name, Round_Description)

datatable(
  display_sub,
  filter = "top",
  options = dt_opts,
  escape = FALSE,
  rownames = FALSE,
  extensions = c("Buttons", "FixedHeader")
)

```



## Legacy points

```{r legacy-table, results='asis', message=FALSE, warning=FALSE, echo=FALSE}

legacy <- all_data %>% group_by(Submitter_Name) %>%
  summarize(sum = sum(`Points Assigned`), leagues = n_distinct(Source_Export), abs = sum(abs(`Points Assigned`)) ) %>%
  arrange(desc(sum))

## add league wins
league_wins <- all_data %>% group_by(Submitter_Name, Source_Export) %>%
  summarize(mean = sum(`Points Assigned`)) %>%
  group_by(Source_Export) %>%
  filter(mean == max(mean)) %>%
  group_by(Submitter_Name) %>%
  summarize(wins = n())

legacy <- left_join(legacy, league_wins, by="Submitter_Name") %>%
  mutate(league_wins = if_else(!is.na(wins), wins, 0)) %>%
  select(-wins)

## add round wins

round_wins <- all_data %>% group_by(Submitter_Name, Source_Export, Round_Name) %>%
  summarize(mean = sum(`Points Assigned`)) %>%
  group_by(Source_Export, Round_Name) %>%
  filter(mean == max(mean)) %>%
  group_by(Submitter_Name) %>%
  summarize(wins = n())

legacy <- left_join(legacy, round_wins, by="Submitter_Name") %>%
  mutate(round_wins = if_else(!is.na(wins), wins, 0)) %>% select(-wins) %>%
  rename(abs_value_votes = abs)

## most upvotes

upvotes <- all_data %>% group_by(Submitter_Name) %>%
  filter(`Points Assigned` > 0) %>%
  summarize(upvotes = sum(`Points Assigned`))

## most downvotes
downvotes <- all_data %>% group_by(Submitter_Name) %>%
  filter(`Points Assigned` < 0) %>%
  summarize(downvotes = sum(`Points Assigned`))

legacy <- left_join(legacy, upvotes, by="Submitter_Name") %>%
  left_join(downvotes, by="Submitter_Name") %>%
  select(Submitter_Name, leagues, sum, upvotes, downvotes, league_wins, round_wins, abs_value_votes)



datatable(
  legacy,
  filter = "none",
  options = dt_opts,
  rownames = FALSE,
  extensions = c("Buttons", "FixedHeader")
)
```

## Average Points Received Per Round

Average points received per round is a bit tricky to calculate, since the number of voters and points varies. I calculated the percentage of available votes (not include their own votes) everyone received in every round they played in, and then averaged that to get `percentage`. I then multiplied that by 76 (the number of available points in a typical round, assuming 5 upvotes / 1 downvotes / 20 total players) to get `avg_points`, so `avg_points` is not actually your average points but the average you are expected to get in a typical round. `sd` is the standard deviation -- higher indicates more variance (also affected by how many rounds you've played, so easiest to compare people who have played all 44). 

```{r average-points, results='asis', message=FALSE, warning=FALSE, echo=FALSE}
avail_points <- all_data %>%
  group_by(Source_Export, Round_Name) %>%
  summarize(round_votes = sum(`Points Assigned`),
            voters = length(unique(Voter_Name))) %>%
  mutate(available_points = round_votes/voters * (voters-1)) %>%
  select(-round_votes, voters) 

all_data %>%
  group_by(Source_Export, Round_Name, Submitter_Name) %>%
  summarize(points = sum(`Points Assigned`), .groups = "drop") %>%
  left_join(avail_points, by = c("Source_Export", "Round_Name")) %>%
  mutate(per_points_gotten = points / available_points) %>%
  group_by(Submitter_Name) %>%
  summarize(
    percentage = mean(per_points_gotten),
    sd = sd(per_points_gotten),
    rounds = length(unique(Round_Name)),
    .groups = "drop"
  ) %>%
  mutate(
    avg_points = percentage * 19 * 4,
    avg_points = round(avg_points, 2),   # 1 decimal place
    percentage = round(percentage, 3),   # 3 decimals
    sd = round(sd, 3)                    # 3 decimals
  ) %>%
  select(Submitter_Name, avg_points, rounds, percentage, sd) %>%
  arrange(desc(avg_points)) %>%
  datatable(
    filter = "none",
    options = dt_opts,
    rownames = FALSE,
    extensions = c("Buttons", "FixedHeader")
  )

```



## Biggest fans and haters of each other

```{r biggest fans and haters, message=FALSE, warning=FALSE, echo=FALSE}
## biggest fans and haters


# pairwise totals
totals <- all_data %>%
  filter(Submitter_Name != Voter_Name) %>% 
  group_by(Submitter_Name, Voter_Name) %>%
  summarise(total = sum(`Points Assigned`), .groups = "drop")

# who each person has given votes to (max and min)
givers <- totals %>%
  group_by(Submitter_Name) %>%
  summarise(
    has_given_most_votes_to = paste(Voter_Name[total == max(total)], collapse = ", "),
    has_given_least_votes_to = paste(Voter_Name[total == min(total)], collapse = ", "),
    .groups = "drop"
  )

# who each person has gotten votes from (max and min)
receivers <- totals %>%
  group_by(Voter_Name) %>%
  summarise(
    has_gotten_most_votes_from = paste(Submitter_Name[total == max(total)], collapse = ", "),
    has_gotten_least_votes_from = paste(Submitter_Name[total == min(total)], collapse = ", "),
    .groups = "drop"
  ) %>%
  rename(person = Voter_Name)

# final table
givers %>%
  rename(person = Submitter_Name) %>%
  left_join(receivers, by = "person") %>%
  rename("Has given most votes to..." = has_given_most_votes_to,
         "Has given fewest votes to..." = has_given_least_votes_to,
         "Has gotten most votes from..." = has_gotten_most_votes_from,
         "Has gotten fewest votes from..." = has_gotten_least_votes_from) %>% kable()

```


## Most chosen artists
```{r most chosen artists, message=FALSE, warning=FALSE, echo=FALSE}
## most chosen artists

just_submissions %>% group_by(`Artist(s)`) %>% count() %>% arrange(desc(n)) %>% 
  head(10) %>% kable()

```

## Most upvoted artists

Which artists have gotten the most upvotes?

``` {r most upvoted artists, message=FALSE, warning=FALSE, echo=FALSE}
all_data %>% 
  group_by(`Artist(s)`) %>% 
  summarize(votes = sum(`Points Assigned`),
            songs = length(unique(Submissions_Time))) %>% 
  arrange(desc(votes)) %>%
  head(10) %>% kable()
```

## Highest average upvote artists

Which repeat artists have gotten the most upvotes on average?

``` {r most avg upvotes artists, message=FALSE, warning=FALSE, echo=FALSE}
all_data %>% 
  group_by(`Artist(s)`) %>% 
  summarize(points = sum(`Points Assigned`),
            songs = length(unique(Submissions_Time))) %>%
  mutate(avg = round(points/songs, 1)) %>%
  filter(songs > 1) %>%
  rename(`Total points` = points,
         `Submissions` = songs,
         Average = avg) %>%
  arrange(desc(Average)) %>% head(10) %>% kable()

```



## Most chosen songs

```{r most chosen songs, message=FALSE, warning=FALSE, echo=FALSE}
## most chosen songs

just_submissions %>% group_by(Title, `Artist(s)`) %>% count() %>% arrange(desc(n)) %>% filter(n > 1) %>% kable()

```

## Most upvoted submissions
```{r most upvoted, message=FALSE, warning=FALSE, echo=FALSE}

## most upvoted submissions

all_data %>% 
  group_by(Title, `Artist(s)`, Submitter_Name, Round_Name, Round_Description) %>% 
  summarize(total_votes = sum(`Points Assigned`)) %>% arrange(desc(total_votes)) %>%
  head(10) %>% kable()


```

## Most downvoted submissions
```{r most downvoted submissions, message=FALSE, warning=FALSE, echo=FALSE}
## most downvoted submissions

all_data %>% 
  group_by(Title, `Artist(s)`, Submitter_Name, Round_Name, Round_Description) %>% 
  summarize(total_votes = sum(`Points Assigned`)) %>% arrange(total_votes) %>%
  head(10) %>% kable()

```


## Full table of all data
```{r all-data-table, results='asis', echo=FALSE, message=FALSE, warning=FALSE}
# Build a clean display frame with transformed columns
display_all <- all_data %>% 
  mutate(
    `Playlist URL` = linkify(`Playlist URL`),
    Round_Description = shorten_with_tooltip(Round_Description, 120),
    Submitter_Comment = shorten_with_tooltip(Submitter_Comment, 120),
    Voter_Comment = shorten_with_tooltip(Voter_Comment, 120)
  )

datatable(
  display_all,
  filter = "top",
  options = dt_opts,
  escape = FALSE,         # we added safe HTML (links + tooltips)
  rownames = FALSE,
  extensions = c("Buttons", "FixedHeader"),
  class = "stripe hover order-column row-border"
)

```

